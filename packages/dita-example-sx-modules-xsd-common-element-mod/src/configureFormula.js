import contentBoundaryType from 'fontoxml-base-flow/src/contentBoundaryType.js';
import defaultTraverser from 'fontoxml-families/src/shared/defaultTraverser.js';
import addAttributeIndex from 'fontoxml-indices/src/addAttributeIndex.js';
import configureAsRemoved from 'fontoxml-families/src/configureAsRemoved.js';

import InsertFormulaCommand from './api/InsertFormulaCommand.js';
import FormulaTemplate from './api/FormulaTemplate.js';

const TEXT_SELECTOR_FOR_FORMULA =
	'self::text()[preceding-sibling::processing-instruction()[name(.)="fontoxml-formula"] and following-sibling::processing-instruction()[name(.)="fontoxml-formula-end"]]';

const PI_SELECTOR_FOR_FORMULA = 'self::processing-instruction()[name(.)="fontoxml-formula"]';

const selector = PI_SELECTOR_FOR_FORMULA;

export default function configureFormula(sxModule) {
	addAttributeIndex(null, 'id', 'http://www.fontoxml.com/functions', 'id-lookup');

	configureAsRemoved(sxModule, TEXT_SELECTOR_FOR_FORMULA);

	sxModule.configure('commands').addCommand('insert-formula', new InsertFormulaCommand());

	sxModule
		.configure('fontoxml-base-flow')
		.forNodesMatching(selector)
		.isAutogenerated(false)
		.isAutomergeable(false)
		.isClosed(false)
		.isDetached(false)
		.isIgnoredForNavigation(false)
		.isRemovableIfEmpty(true)
		.isSplittable(false)
		.nodeIsContent(false)
		.selectBeforeDelete(true)
		.withContentBoundaryType(contentBoundaryType.NONE);

	sxModule
		.configure('fontoxml-block-flow')
		.forNodesMatching(selector)
		.withBlockTypes([]);

	sxModule
		.configure('fontoxml-families')
		.forNodesMatching(selector)
		.isSheetFrame(false)
		.withInnerLayoutType('inline')
		.withLayoutType('inline');

	sxModule
		.configure('fontoxml-templated-views')
		.stylesheet('content')
		.renderNodesMatching(selector)
		.withTraverser(defaultTraverser)
		.withTemplate(new FormulaTemplate());
}
